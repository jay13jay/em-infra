---
- name: Prepare Talos base template on Proxmox
  hosts: proxmox
  gather_facts: false
  vars:
    talos_version: "1.12.4"
    talos_template_name: "talos-v{{ talos_version }}-base"
    talos_template_vmid: 9000
    talos_template_storage: "tank"
    talos_iso_storage: "local"
    talos_iso_filename: "talos-v{{ talos_version }}-metal-amd64.iso"
    talos_iso_volume: "{{ talos_iso_storage }}:iso/{{ talos_iso_filename }}"
    template_cores: 2
    template_memory_mb: 4096
    template_disk_gb: 20
    template_bridge: "vmbr0"
    talos_autoinstall: false
    talos_autoinstall_config_url: ""
    talos_install_disk: "/dev/sda"
    talos_autoinstall_hostname: "{{ talos_template_name }}"
    finalize_template: false
    wait_timeout_seconds: 300

  tasks:
    - name: Validate Talos template naming contract
      ansible.builtin.assert:
        that:
          - talos_template_name is match('^talos-v[0-9]+\.[0-9]+\.[0-9]+-base$')
        fail_msg: "talos_template_name must follow talos-v<major>.<minor>.<patch>-base (example: talos-v1.12.4-base)."

    - name: Check that Talos ISO exists in Proxmox storage
      ansible.builtin.command:
        cmd: "pvesm path {{ talos_iso_volume }}"
      register: talos_iso_path
      changed_when: false

    - name: Check whether template VMID already exists
      ansible.builtin.command:
        cmd: "qm status {{ talos_template_vmid }}"
      register: vm_status
      failed_when: false
      changed_when: false

    - name: Create Talos installer VM when absent
      ansible.builtin.command:
        cmd: >-
          qm create {{ talos_template_vmid }}
          --name {{ talos_template_name }}
          --memory {{ template_memory_mb }}
          --cores {{ template_cores }}
          --cpu host
          --net0 virtio,bridge={{ template_bridge }}
          --ostype l26
          --scsihw virtio-scsi-pci
      when: vm_status.rc != 0

    - name: Configure template disk
      ansible.builtin.command:
        cmd: "qm set {{ talos_template_vmid }} --scsi0 {{ talos_template_storage }}:{{ template_disk_gb }}"
      changed_when: false
      when: vm_status.rc != 0

    - name: Attach Talos installer ISO
      ansible.builtin.command:
        cmd: "qm set {{ talos_template_vmid }} --ide2 {{ talos_iso_volume }},media=cdrom"
      changed_when: false

    - name: Build Talos autoinstall kernel args
      ansible.builtin.set_fact:
        talos_kernel_args: >-
          talos.platform=metal
          talos.install=yes
          talos.install.disk={{ talos_install_disk }}
          talos.install.poweroff=true
          talos.config={{ talos_autoinstall_config_url }}
          talos.hostname={{ talos_autoinstall_hostname }}
      when: talos_autoinstall | bool

    - name: Assert autoinstall config URL is provided when enabled
      ansible.builtin.assert:
        that:
          - talos_autoinstall_config_url | length > 0
        fail_msg: "talos_autoinstall is true but talos_autoinstall_config_url is empty. Provide a Talos machine config URL."
      when: talos_autoinstall | bool

    - name: Apply autoinstall kernel args
      ansible.builtin.command:
        cmd: >-
          qm set {{ talos_template_vmid }}
          --args "-append \"{{ talos_kernel_args }}\""
      changed_when: false
      when: talos_autoinstall | bool

    - name: Configure boot order for install stage
      ansible.builtin.command:
        cmd: 'qm set {{ talos_template_vmid }} --boot order=ide2;scsi0'
      changed_when: false
      when: not (finalize_template | bool)

    - name: Start installer VM for Talos install
      ansible.builtin.command:
        cmd: "qm start {{ talos_template_vmid }}"
      register: start_result
      changed_when: start_result.rc == 0
      failed_when: false
      when: not finalize_template

    - name: Install checkpoint for operator
      ansible.builtin.debug:
        msg:
          - "Installer VM {{ talos_template_vmid }} is ready for Talos installation."
          - "Open Proxmox console and install Talos from ISO to disk."
          - "After install completes and VM is powered off, re-run this playbook with -e finalize_template=true."
      when: not finalize_template

    - name: End play after install stage
      ansible.builtin.meta: end_play
      when: not finalize_template

    - name: Request graceful shutdown before template conversion
      ansible.builtin.command:
        cmd: "qm shutdown {{ talos_template_vmid }}"
      failed_when: false
      when: finalize_template | bool

    - name: Wait until VM is stopped
      ansible.builtin.command:
        cmd: "qm status {{ talos_template_vmid }}"
      register: stop_status
      changed_when: false
      until: "'status: stopped' in stop_status.stdout"
      retries: "{{ (wait_timeout_seconds | int) // 5 }}"
      delay: 5
      when: finalize_template | bool

    - name: Ensure boot order points to disk
      ansible.builtin.command:
        cmd: "qm set {{ talos_template_vmid }} --boot order=scsi0"
      changed_when: false
      when: finalize_template | bool

    - name: Detach installer ISO
      ansible.builtin.command:
        cmd: "qm set {{ talos_template_vmid }} --ide2 none,media=cdrom"
      changed_when: false
      when: finalize_template | bool

    - name: Ensure final template name
      ansible.builtin.command:
        cmd: "qm set {{ talos_template_vmid }} --name {{ talos_template_name }}"
      changed_when: false
      when: finalize_template | bool

    - name: Remove autoinstall kernel args
      ansible.builtin.command:
        cmd: "qm set {{ talos_template_vmid }} --delete args"
      changed_when: false
      when: finalize_template and talos_autoinstall | bool

    - name: Convert VM to template
      ansible.builtin.command:
        cmd: "qm template {{ talos_template_vmid }}"
      when: finalize_template | bool

    - name: Report completion
      ansible.builtin.debug:
        msg: "Talos base template ready: vmid={{ talos_template_vmid }}, name={{ talos_template_name }}"
      when: finalize_template | bool
